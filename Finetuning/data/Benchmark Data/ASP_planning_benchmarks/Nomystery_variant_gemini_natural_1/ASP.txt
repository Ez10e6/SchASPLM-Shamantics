% Define time steps from 1 to S.
% (Note: step/1 is usually defined in the instance or command line, here we assume it exists).

% Generate exactly one action per time step: load, unload, or drive.
{ occurs(A,S) : action(A) } <= 1 :- step(S).

% Constraint: Actions must occur sequentially (no gaps in the plan).
done(S) :- occurs(A,S), step(S).
:- done(S), not done(S-1), 1 < S, step(S).

% Define specific action predicates based on occurrence.
unload( P,T,L,S )  :- occurs(unload(P,T,L),S), step(S).
load( P,T,L,S )    :- occurs(load(P,T,L),S), step(S).
drive( T,L1,L2,S ) :- occurs(drive(T,L1,L2),S), step(S).

% Effect: Unloading a package places it at the location and removes it from the truck.
at( P,L,S ) :- unload( P,T,L,S ), step(S).
del( in( P,T ),S ) :- unload( P,T,L,S ), step(S).

% Effect: Loading a package places it in the truck and removes it from the location.
del( at( P,L ),S ) :- load( P,T,L,S ), step(S).
in( P,T,S ) :- load( P,T,L,S ), step(S).

% Effect: Driving moves a truck to a new location and reduces its fuel by the travel cost.
del( at( T,L1 ), S ) :- drive( T,L1,L2,S ), step(S).
at( T,L2,S ) :- drive( T,L1,L2,S), step(S).
del( fuel( T,Fuelpre ),S ) :- drive( T,L1,L2,S ), fuel(T, Fuelpre,S-1), step(S).
fuel( T,Fuelpre - Fueldelta,S ) :- drive( T,L1,L2,S ), fuelcost(Fueldelta,L1,L2), fuel(T,Fuelpre,S-1), Fuelpre >= Fueldelta, step(S).

% Inertia: Packages and trucks stay where they are unless moved.
at( O,L,S ) :- at( O,L,S-1 ), not del( at( O,L ),S  ), step(S).
in( P,T,S ) :- in( P,T,S-1 ), not del( in( P,T ),S  ), step(S).

% Inertia: Fuel levels remain constant unless fuel is consumed.
fuel( T,Level,S ) :- fuel( T,Level,S-1 ), not del( fuel( T,Level) ,S ), truck( T ), step(S).

% Precondition: To unload, the truck must be at the location and carrying the package.
:- unload( P,T,L,S ), not preconditions_u( P,T,L,S ), step(S).
preconditions_u( P,T,L,S ) :- step(S), at( T,L,S-1 ), in( P,T,S-1 ), package( P ), truck( T ).

% Precondition: To load, the truck and package must be at the same location.
:- load( P,T,L,S ), not preconditions_l( P,T,L,S ), step(S).
preconditions_l( P,T,L,S ) :- step(S), at( T,L,S-1 ), at( P,L,S-1 ).

% Precondition: To drive, the truck must be at the start location and have sufficient fuel.
:- drive( T,L1,L2,S ), not preconditions_d( T,L1,L2,S ), step(S).
preconditions_d( T,L1,L2,S ) :- step(S), at( T,L1,S-1 ), fuel( T, Fuelpre, S-1), fuelcost(Fueldelta,L1,L2), Fuelpre >= Fueldelta.

% Goal: All packages must be at their target locations at the final time step.
:- goal(P,L), not at(P,L,S), step(S), not step(S+1).