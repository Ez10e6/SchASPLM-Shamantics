% Define domain predicates for courses, teachers, rooms, days, and periods.
c(C) :- course(C,_,_,_,_,_).
t(T) :- course(_,T,_,_,_,_).
r(R) :- room(R,_,_).
d(0..D-1) :- days(D).
ppd(0..P-1) :- periods_per_day(P).
cu(Cu) :- curricula(Cu,_).

% Generate assignment: Each course must be assigned to exactly N distinct periods based on its lecture count.
N { assigned(C,D,P) : d(D), ppd(P) } N :- course(C,_,N,_,_,_).

% Constraint: Lectures for the same curriculum or teacher must not be assigned to the same period (Conflicts).
:- not { assigned(C,D,P) : course(C,T,_,_,_,_) } 1, t(T), d(D), ppd(P).
:- not { assigned(C,D,P) : curricula(Cu,C) } 1, cu(Cu), d(D), ppd(P).

% Generate room assignment: Each scheduled lecture must be assigned to exactly one room.
1 { assigned(C,R,D,P) : r(R) } 1 :- assigned(C,D,P).

% Constraint: No two lectures can be assigned to the same room in the same period.
:- not { assigned(C,R,D,P) : c(C) } 1, r(R), d(D), ppd(P).

% Constraint: Lectures cannot be assigned to periods where the teacher is unavailable.
:- assigned(C,D,P), unavailability_constraint(C,D,P).

% Define 'working_day' helper: A course has a working day if a lecture is assigned to that day.
working_day(C,D) :- assigned(C,D,P).

% Define 'scheduled_curricula' helper: Maps curricula to scheduled days and periods.
scheduled_curricula(Cu,D,P) :- assigned(C,D,P), curricula(Cu,C).

% Define 'using_room' helper: Tracks which rooms are used by which courses.
using_room(C,R) :- assigned(C,R,D,P).

% Soft Constraint (RoomCapacity): Apply penalty if student count exceeds room capacity.
penalty("RoomCapacity",assigned(C,R,D,P),(N-Cap)*W,Prior) :- assigned(C,R,D,P), course(C,_,_,_,N,_), room(R,Cap,_), N > Cap, soft_constraint("RoomCapacity",W,Prior).

% Soft Constraint (MinWorkingDays): Apply penalty if the number of working days for a course is less than the minimum.
penalty("MinWorkingDays",course(C,MWD,N),(MWD-N)*W,Prior) :- course(C,_,_,MWD,_,_), N = { working_day(C,D) }, N < MWD, soft_constraint("MinWorkingDays",W,Prior).

% Soft Constraint (IsolatedLectures): Apply penalty if a lecture in a curriculum is not adjacent to another lecture on the same day.
penalty("IsolatedLectures",isolated_lectures(Cu,D,P),W,Prior) :- scheduled_curricula(Cu,D,P), not scheduled_curricula(Cu,D,P-1), not scheduled_curricula(Cu,D,P+1), soft_constraint("IsolatedLectures",W,Prior).

% Soft Constraint (Windows): Apply penalty for gaps between the first and last lecture of a curriculum on a day.
penalty("Windows",windows(Cu,D,P1,P2),(P2-P1-1)*W,Prior) :- scheduled_curricula(Cu,D,P1), scheduled_curricula(Cu,D,P2), P1 + 1 < P2, not scheduled_curricula(Cu,D,P) : P = P1+1..P2-1; soft_constraint("Windows",W,Prior).

% Soft Constraint (RoomStability): Apply penalty for each additional room used by a course beyond the first.
penalty("RoomStability",using_room(C,N),(N-1)*W,Prior) :- c(C), N = { using_room(C,R) }, N > 1, soft_constraint("RoomStability",W,Prior).

% Soft Constraint (StudentMinMaxLoad): Apply penalty if daily lectures for a curriculum are outside the allowed range.
penalty("StudentMinMaxLoad",student_min_max_load(Cu,D,N,many),(N-Max)*W,Prior) :- cu(Cu), d(D), N = { scheduled_curricula(Cu,D,P) }, min_max_daily_lectures(Min,Max), N > Max, soft_constraint("StudentMinMaxLoad",W,Prior).
penalty("StudentMinMaxLoad",student_min_max_load(Cu,D,N,few),(Min-N)*W,Prior) :- cu(Cu), d(D), N = { scheduled_curricula(Cu,D,P) }, min_max_daily_lectures(Min,Max), 0 < N, N < Min, soft_constraint("StudentMinMaxLoad",W,Prior).

% Soft Constraint (TravelDistance): Apply penalty if consecutive lectures for a curriculum occur in different buildings.
penalty("TravelDistance",instantaneous_move(Cu,C1,C2,D,P,P+1),W,Prior) :- curricula(Cu,C1), curricula(Cu,C2), assigned(C1,R1,D,P), assigned(C2,R2,D,P+1), room(R1,_,BLG1), room(R2,_,BLG2), BLG1 != BLG2, soft_constraint("TravelDistance",W,Prior).

% Soft Constraint (RoomSuitability): Apply penalty if a course is assigned to an unsuitable room.
penalty("RoomSuitability",assigned(C,R,D,P),W,Prior) :- assigned(C,R,D,P), room_constraint(C,R), soft_constraint("RoomSuitability",W,Prior).

% Soft Constraint (DoubleLectures): Apply penalty if a course requiring double lectures is not grouped.
penalty("DoubleLectures",non_grouped_lecture(C,R,D,P),W,Prior) :- course(C,_,_,_,_,1), d(D), 2 { assigned(C,D,PPD) }, assigned(C,R,D,P), not assigned(C,R,D,P-1), not assigned(C,R,D,P+1), soft_constraint("DoubleLectures",W,Prior).

% Minimize the total weighted penalty.
#minimize { P@L,C,S : penalty(S,C,P,L) }.